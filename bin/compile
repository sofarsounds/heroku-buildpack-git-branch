#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

# fail fast
set -e

BUILD_DIR="$1"
CACHE_DIR="$2"
ENV_DIR="$3"
PROFILE_PATH="$BUILD_DIR/.profile.d/git-branch.sh"

create_env() {
  # populate profile.d
  mkdir -p $(dirname $PROFILE_PATH)
}

write_profile() {
  BRANCH="$(git ls-remote git@github.com:sofarsounds/sofar-main.git | grep $SOURCE_VERSION | sed 's/^.*refs\/heads\///' | sed 's/\//_/')"

  echo "=====> Writing branch version ($SOURCE_VERSION) to $PROFILE_PATH"
  echo "Branch version is $BRANCH"
  echo "export GIT_BRANCH=\"$BRANCH\"" >> $PROFILE_PATH
}

create_env
write_profile

exit 0
